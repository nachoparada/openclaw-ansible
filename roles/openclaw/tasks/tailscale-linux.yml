---
# Linux-specific Tailscale installation (Debian/Ubuntu)

- name: Add Tailscale GPG key
  ansible.builtin.get_url:
    # NOTE: Keep this URL on a single line. YAML folded scalars (`>`) insert
    # spaces/newlines, which can corrupt URLs (e.g., "ubuntu/ noble...").
    url: "https://pkgs.tailscale.com/stable/{{ ansible_distribution | lower }}/{{ ansible_distribution_release }}.noarmor.gpg"  # noqa: yaml[line-length]
    dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
    mode: "0644"

- name: Add Tailscale repository
  ansible.builtin.apt_repository:
    repo: >
      deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg]
      https://pkgs.tailscale.com/stable/{{ ansible_distribution | lower }}
      {{ ansible_distribution_release }} main
    filename: tailscale
    state: present
    update_cache: true

- name: Install Tailscale
  ansible.builtin.apt:
    name: tailscale
    state: present

- name: Enable Tailscale service (Linux)
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started

- name: Check if Tailscale is already connected (Linux)
  ansible.builtin.command: tailscale status --json
  register: tailscale_status_linux
  changed_when: false
  failed_when: false

- name: Set Tailscale connection status
  ansible.builtin.set_fact:
    tailscale_connected: "{{ (tailscale_status_linux.stdout | from_json).BackendState == 'Running' }}"
  when: tailscale_status_linux.rc == 0 and tailscale_status_linux.stdout | length > 0

- name: Set Tailscale connection status (fallback)
  ansible.builtin.set_fact:
    tailscale_connected: false
  when: tailscale_status_linux.rc != 0 or tailscale_status_linux.stdout | length == 0

- name: Connect to Tailscale using auth key (Linux)
  ansible.builtin.command: tailscale up --authkey {{ tailscale_authkey }} --ssh
  when: not tailscale_connected and tailscale_authkey | length > 0
  no_log: true
  changed_when: true

- name: Display Tailscale connection status (Linux)
  ansible.builtin.debug:
    msg: "âœ… Tailscale connected with SSH enabled"
  when: not tailscale_connected and tailscale_authkey | length > 0

- name: Display Tailscale auth URL if not connected (Linux)
  ansible.builtin.debug:
    msg:
      - "============================================"
      - "Tailscale installed but not connected yet"
      - "============================================"
      - ""
      - "To connect this machine to your Tailnet:"
      - "Run: sudo tailscale up --ssh"
      - ""
      - "For unattended installation, use an auth key:"
      - "sudo tailscale up --authkey tskey-auth-xxxxx --ssh"
      - ""
      - "Get auth key from: https://login.tailscale.com/admin/settings/keys"
  when: not tailscale_connected and tailscale_authkey | length == 0
