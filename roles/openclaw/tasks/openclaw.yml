---
- name: Create OpenClaw directories (structure only, no config files)
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ openclaw_config_dir }}", mode: '0755' }
    - { path: "{{ openclaw_config_dir }}/sessions", mode: '0755' }
    - { path: "{{ openclaw_config_dir }}/credentials", mode: '0700' }
    - { path: "{{ openclaw_config_dir }}/data", mode: '0755' }
    - { path: "{{ openclaw_config_dir }}/logs", mode: '0755' }

- name: Create pnpm directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0755'
  loop:
    - "{{ openclaw_home }}/.local/share/pnpm"
    - "{{ openclaw_home }}/.local/share/pnpm/store"
    - "{{ openclaw_home }}/.local/bin"

- name: Ensure pnpm directories have correct ownership
  ansible.builtin.file:
    path: "{{ openclaw_home }}/.local/share/pnpm"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    recurse: true
    mode: '0755'

- name: Configure pnpm for openclaw user
  ansible.builtin.shell:
    cmd: |
      pnpm config set global-dir {{ openclaw_home }}/.local/share/pnpm
      pnpm config set global-bin-dir {{ openclaw_home }}/.local/bin
    executable: /bin/bash
  become: true
  become_user: "{{ openclaw_user }}"
  changed_when: true  # Always consider changed as pnpm config may update

- name: Display installation mode
  ansible.builtin.debug:
    msg: "Installation mode: {{ openclaw_install_mode }}"

# Include appropriate installation method based on mode
- name: Include release installation (pnpm install -g)
  ansible.builtin.include_tasks: openclaw-release.yml
  when: openclaw_install_mode == "release"

- name: Include development installation (git clone + build + link)
  ansible.builtin.include_tasks: openclaw-development.yml
  when: openclaw_install_mode == "development"

- name: Configure .bashrc for openclaw user (base config)
  ansible.builtin.blockinfile:
    path: "{{ openclaw_home }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - OpenClaw pnpm"
    block: |
      # pnpm configuration
      export PNPM_HOME="{{ openclaw_home }}/.local/share/pnpm"
      export PATH="{{ openclaw_home }}/.local/bin:$PNPM_HOME:$PATH"
    create: true
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0644'
    insertafter: EOF

# NOTE: We do NOT create config.yml here - openclaw onboard/configure will do that
# We also do NOT install the systemd service - openclaw onboard --install-daemon will do that
# The .openclaw directory structure is created above, but config and gateway are user-initiated

# Generate gateway token if not provided
- name: Generate gateway authentication token
  ansible.builtin.set_fact:
    openclaw_gateway_token: "{{ lookup('community.general.random_string', length=64, special=false) }}"
  when: openclaw_gateway_token | length == 0 and openclaw_seed_gateway_config | bool
  no_log: true

- name: Display gateway token generation status
  ansible.builtin.debug:
    msg: "Gateway authentication token auto-generated (64 characters)"
  when: openclaw_gateway_token | length > 0 and openclaw_seed_gateway_config | bool

# Seed gateway configuration with secure defaults
- name: Seed gateway configuration file
  ansible.builtin.copy:
    dest: "{{ openclaw_config_dir }}/openclaw.json"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0600'
    force: false  # Don't overwrite if exists
    content: |
      {
        "gateway": {
          "mode": "{{ openclaw_gateway_mode }}",
          "bind": "{{ 'loopback' if openclaw_gateway_bind == 'loopback' else 'all' }}",
          "port": {{ openclaw_gateway_port }},
          "auth": {
            "mode": "token",
            "token": "{{ openclaw_gateway_token }}"
          },
          "tailscale": {
            "mode": "{{ openclaw_gateway_tailscale_mode }}"
          }
        }
      }
  when: openclaw_seed_gateway_config | bool
  no_log: true

- name: Display gateway configuration status
  ansible.builtin.debug:
    msg: >-
      Gateway config seeded with secure defaults
      (bind: {{ openclaw_gateway_bind }}, mode: {{ openclaw_gateway_mode }})
  when: openclaw_seed_gateway_config | bool

# Auto-start gateway on Linux (uses systemd)
- name: Install openclaw gateway service (Linux)
  ansible.builtin.shell:
    cmd: openclaw gateway install
    executable: /bin/bash
  environment:
    PATH: "{{ openclaw_path }}"
    HOME: "{{ openclaw_home }}"
    XDG_RUNTIME_DIR: "/run/user/{{ openclaw_uid_value | default(ansible_user_uid) }}"
  become: true
  become_user: "{{ openclaw_user }}"
  when: openclaw_start_gateway | bool and ansible_os_family == 'Debian'
  register: gateway_install
  changed_when: gateway_install.rc == 0

- name: Start openclaw gateway service (Linux)
  ansible.builtin.shell:
    cmd: openclaw gateway start
    executable: /bin/bash
  environment:
    PATH: "{{ openclaw_path }}"
    HOME: "{{ openclaw_home }}"
    XDG_RUNTIME_DIR: "/run/user/{{ openclaw_uid_value | default(ansible_user_uid) }}"
  become: true
  become_user: "{{ openclaw_user }}"
  when: openclaw_start_gateway | bool and ansible_os_family == 'Debian' and gateway_install is succeeded
  register: gateway_start
  changed_when: gateway_start.rc == 0
  failed_when: false  # Don't fail if gateway start has issues (may need channel config)

- name: Display gateway status
  ansible.builtin.debug:
    msg: "OpenClaw gateway installed and started"
  when: openclaw_start_gateway | bool and ansible_os_family == 'Debian' and gateway_install is succeeded

- name: Display configuration note (gateway started)
  ansible.builtin.debug:
    msg: |
      OpenClaw is installed and gateway is running.

      Next steps (run as openclaw user):
      1. Switch user: sudo su - openclaw
      2. Run onboarding: openclaw onboard

      This will:
      - Guide you through channel setup
      - Configure your messaging channels

      Gateway commands:
      - openclaw gateway status
      - openclaw gateway restart
      - openclaw logs
  when: openclaw_start_gateway | bool and ansible_os_family == 'Debian'

- name: Display configuration note (manual setup)
  ansible.builtin.debug:
    msg: |
      OpenClaw is installed but NOT configured yet.

      Next steps (run as openclaw user):
      1. Switch user: sudo su - openclaw
      2. Run onboarding: openclaw onboard --install-daemon

      This will:
      - Create configuration files (~/.openclaw/openclaw.json)
      - Guide you through channel setup
      - Install and start the gateway service automatically
  when: not (openclaw_start_gateway | bool and ansible_os_family == 'Debian')
